<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ... (your head content) ... -->
</head>

<body>
  <button id="start-camera">Start Kegiatan</button>
  <video id="video" width="320" height="240" autoplay></video>
  <br>
  <h4>Input Comparison Image</h4>
  <input id="comparison-image" type="file">
  <h1 id="message">Not Scanned</h1>
  <button id="start-record">Start Record</button>
  <button id="stop-record">Stop Record</button>
  <button id="post-data">Post Data</button>
  
  <a id="download-video" style="display: none" download="recorded_video.webm">Download Video</a>
</body>
<script src="https://code.jquery.com/jquery-3.7.0.js" crossorigin="anonymous"></script>
<script>
  let camera_button = document.querySelector("#start-camera");
  let video = document.querySelector("#video");
  let start_button = document.querySelector("#start-record");
  let stop_button = document.querySelector("#stop-record");
  let download_link = document.querySelector("#download-video");
  let post_button = document.querySelector("#post-data");
  let comparison_image_input = document.querySelector("#comparison-image");

  let camera_stream = null;
  let media_recorder = null;
  let blobs_recorded = [];
  let comparison_image = null;

  comparison_image_input.addEventListener('change', function (event) {
    comparison_image = event.target.files[0];
  });

  camera_button.addEventListener('click', async function () {
    $("#message").html("On Scanning Please Wait!")
    camera_stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    video.srcObject = camera_stream;
    $("button").click(function () {
      
    });
  });

  start_button.addEventListener('click', function () {
    // set MIME type of recording as video/webm
    media_recorder = new MediaRecorder(camera_stream, { mimeType: 'video/webm' });

    // event : new recorded video blob available 
    media_recorder.addEventListener('dataavailable', function (e) {
      blobs_recorded.push(e.data);
    });

    // event : recording stopped & all blobs sent
    media_recorder.addEventListener('stop', function () {
      // create local object URL from the recorded video blobs
      let video_local = URL.createObjectURL(new Blob(blobs_recorded, { type: 'video/webm' }));
      download_link.href = video_local;
      // Display a message indicating that the recording has been saved
      $("#message").html("Recording Saved");
    });

    // Display a message indicating that recording has started
    $("#message").html("Recording Started");

    // start recording with each recorded blob having 1 second video
    media_recorder.start(1000);

    // Stop recording after 5 seconds
    setTimeout(function () {
      media_recorder.stop();
    }, 5000);
  });

  stop_button.addEventListener('click', function () {
    media_recorder.stop();
  });



  // Create a FormData object to send the data
  post_button.addEventListener('click', function () {
    
    let formData = new FormData();
    formData.append('video', new Blob(blobs_recorded, { type: 'video/webm' }));
    formData.append('image', comparison_image);
    if (blobs_recorded.length === 0 || !comparison_image) {
      $("#message").html("Recorded video and comparison image are required.");
      return;
    }

    $("#message").html("Sending Data.");
    $.ajax({
      url: "http://127.0.0.1:7900/verify-video",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      beforeSend: function(xhr) {
        xhr.setRequestHeader("Authorization", "Basic " + btoa("GPM-DEVELOPMENT:GPM-DEVELOPMENT"));
      },
      success: function (result) {
        // Update the message based on the response
        if (result["message"] === "face_match") {
          $("#message").html("Anti-Spoofing Test Passed");
        } else {
          $("#message").html("Anti-Spoofing Test Failed");
        }
      },
      error: function () {
        $("#message").html("Error while sending data.");
      }
    });
  });
</script>

</html>